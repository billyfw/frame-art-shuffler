# Frame Art Shuffler ‚Äì Integration Roadmap & Status# Frame Art Shuffler Integration Roadmap



> Updated **November 1, 2025** after the self-contained architecture refactor.## Context and Guiding Principles

- Home Assistant becomes the single authority for defining Samsung Frame TVs; the add-on consumes `metadata.json` and renders UI.

## 1. Current Architecture- Multiple HA instances may coexist. Each instance manages only the TVs tagged with its own **home** value.

- **Config entry storage** is the single source of truth for TVs. `entry.data["tvs"]` holds name, IP, MAC, shuffle frequency, include tags, and exclude tags per device.- The integration must be installable through HACS, follow HA best practices (config flows, async boundaries, service wrappers), and coordinate cleanly with the add-on.

- **metadata.json** remains for artwork metadata only. The integration no longer writes TV settings to it, but will read it later when picking random images.- The add-on will remove TV CRUD screens, accept update notifications from the integration, and respect the shared `home` identifier when rendering data.

- **No add-on callbacks**. All scheduling, persistence, and state updates live entirely inside Home Assistant.

- **Entity edits** update the config entry directly (via `update_tv_config` helpers) and refresh the coordinator.## Metadata Schema Updates

- **Device removal** deletes the TV from the config entry and cleans up any stored pairing token.- Extend `metadata.json` with a top-level `homes` registry used to prevent duplicate claims:

  ```json

## 2. Completed Work  "homes": {

### Phase 1 ‚Äì HACS Foundation (‚úÖ October 2025)    "Madrone": {

- HACS packaging, manifest metadata, README documentation.      "instance_id": "c8d4f0b5-a0b3-4a25-8135-1e7f7cf27c8f",

- Config flow with home claim guard, pairing, token management, reauth path.      "friendly_name": "Madrone"

- Metadata helper with atomic read/write and home scoping (still available for artwork data).    }

- Coordinator + entities so each Frame TV appears in HA.  }

  ```

### Phase 1.5 ‚Äì HA-Native Storage & Cleanup (‚úÖ November 2025)- `instance_id` is a UUID generated by the integration (persisted in the config entry). `friendly_name` mirrors the home string for clarity and can hold a user-facing label later.

- Removed git persistence (`git_sync.py`) and the try-commit-or-revert UX.- Claim rules:

- Removed add-on communication modules (`notify.py`, `addon_api.py`) and the ‚ÄúSync to Add-on‚Äù button.  1. During config flow, read `homes`. If `home` is absent, write `{instance_id, friendly_name}`.

- Text/number entities now read/write config entry data only.  2. If `home` exists with a different `instance_id`, abort with an error (‚ÄúHome already claimed by another integration instance‚Äù).

- Documentation consolidated into this single roadmap.  3. If `home` exists with the same `instance_id`, continue (allows reconfiguration).

- Provide helpers `claim_home(home, instance_id)` and `release_home(home, instance_id)` inside the integration. Releasing can be added later; note it as a backlog item.

## 3. Roadmap

### Phase 2 ‚Äì Built-in Shuffle Scheduler (üîÑ next)## Phase 1 ‚Äì HACS-Ready Integration Foundation

Goal: the integration handles shuffle timing without user-created automations.**Status:** ‚úÖ Completed (October 2025)

- Add `scheduler.py` with a lightweight `ShuffleScheduler` that keeps one `async_track_time_interval` timer per TV.

- Schedule or reschedule each TV when the config entry changes or on startup, using `shuffle_frequency_minutes`.**Goal:** deliver a minimal integration that installs via HACS, claims a unique home, pairs TVs, and writes scoped entries to `metadata.json`.

- Shuffle execution pipeline (initial version):

  1. Read metadata.json for the artwork library.Key tasks:

  2. Filter by include/exclude tags.1. **Packaging**

  3. Choose a random candidate.   - Add `hacs.json` and ensure `manifest.json` metadata (version, documentation, codeowners) is correct.

  4. Upload via existing `frame_tv.py` helpers.   - Update README with HACS installation instructions.

- Expose a `frame_art_shuffler.shuffle_now` service for manual triggers and external automations.   - Prepare initial tagged release once functionality is verified.



### Phase 3 ‚Äì Observability & Diagnostics (üìù planned)2. **Config flow & reauth**

- **Timer status sensor** per TV (or aggregate) reporting `status`, `last_shuffle`, `next_shuffle`.   - Step 1: request integration-level `home` string; perform home-claim guard using the `homes` registry.

- **Diagnostics dump** that includes scheduler state, outstanding timers, and recent errors.   - Step 2: select existing TV (matching home) or create new; gather TV name, IP/hostname (IPv4, IPv6, mDNS allowed), MAC (normalized using add-on logic), tags, exclude tags, shuffle frequency (minutes).

- **Logging conventions**: DEBUG for timer create/cancel, INFO for each shuffle run, WARNING/ERROR for failures (missing tags, upload issues, etc.).   - Step 3: run Samsung pairing handshake; store token under `/config/frame_art_shuffler/tokens/<safe_ip>.token`.

- Optional entity attributes for ‚Äúlast image displayed‚Äù once shuffle execution lands.   - Persist TV data (with `home`) to `metadata.json` via metadata helper.

   - Implement reauth flow that re-runs pairing when tokens fail.

### Phase 4 ‚Äì Control Surface Expansion (üéØ future)

- Add power/art mode control via `MediaPlayerEntity` or a bespoke platform.3. **Metadata helper module**

- Additional services: brightness, ‚Äúshuffle with filters‚Äù, metadata refresh, etc.   - Read/write `metadata.json` atomically (temp file + rename) under a shared lock.

- Token health checks and automated re-pair prompts when art uploads fail repeatedly.   - Filter `tvs` by `home` when presenting data to HA.

- Additional helper entities (e.g., selects for saved tag sets) if UX calls for them.   - Upsert TVs (ensure IDs are stable UUIDs), normalize tags/notTags arrays, and auto-add new tags to the global tag list.

   - Manage the `homes` registry and expose claim helpers.

### Phase 5 ‚Äì Automation & Analytics (üöÄ longer term)

- Smarter image selection (avoid repeats, time-of-day weighting).4. **Entity scaffolding**

- Repairs notifications or HA events when shuffles fail repeatedly.   - Create a basic per-TV entity (e.g., `FrameArtTVEntity` derived from `CoordinatorEntity`) exposing static attributes (name, IP, MAC, tags) so we can verify the integration registers devices/entities.

- Optional structured shuffle log (`/config/frame_art/shuffle_log.json`).   - No control services yet‚Äîfocus on state reflection and metadata persistence.

- Example automations/blueprints (e.g., shuffle when the house arms away).

5. **Stubbed add-on notification**

## 4. Monitoring & Troubleshooting Plan   - Implement `notify_addon_tv_change(payload)` that logs a TODO; wire it where TVs are created/updated/deleted so drop-in replacement later is trivial.

| Tool | Purpose | Notes |

|------|---------|-------|6. **Validation & tests**

| **Logger** | Enable `custom_components.frame_art_shuffler: debug` to trace scheduler events and shuffle results. | View via *Settings ‚Üí System ‚Üí Logs* or tail `home-assistant.log`. |   - Unit tests for metadata helper (home claim collisions, TV upsert, tag normalization).

| **Timer status sensor** *(Phase 3)* | Surface per-TV timer state, last/next shuffle timestamps. | Useful for dashboards and alerts. |   - Tests for config flow validation (invalid IP/MAC scenarios, home conflict, pairing handshake mocked).

| **Diagnostics JSON** *(Phase 3)* | Download snapshot containing scheduler state, config entry data, recent errors. | Accessible from the integration card. |   - Manual test script: add integration, create TV, inspect `metadata.json`, edit TV via options flow, confirm filtering by home.

| **`shuffle_now` service** *(Phase 2)* | Manual/automation entry point with logged context IDs. | Complements periodic timers. |

Deliverables: updated docs, working integration installable via HACS, passing tests, clear TODOs for Phase 2/3 integration points.

## 5. Deprecated / Removed Components

- Git sync workflow and persistent notifications tied to Git.## Phase 2 ‚Äì Add-on Alignment (external work)

- Add-on HTTP notifications and manual sync buttons.**Goal:** update `ha-frame-art-manager` so it cooperates with the new integration-driven workflow.

- ‚ÄúAdd-on sync failure‚Äù persistent notifications.

**Status:** ‚ö†Ô∏è ARCHITECTURE CHANGED - See [ARCHITECTURE_REFACTOR.md](ARCHITECTURE_REFACTOR.md)

Any remaining references to these features should be cleaned up (`git_sync`, `notify`, `addon_api`).

**New Architecture**: Integration stores TV config in HA config entries, add-on receives updates via HTTP API.

## 6. Add-on Coordination

- No integration ‚Üí add-on communication required now.Required changes:

- Keep metadata.json schema stable so the add-on can continue to display artwork.1. Remove TV creation/edit UI from the "Advanced" area and delete associated REST endpoints (retain `GET /api/tvs` for read-only data).

- Future collaboration can reuse read-only REST endpoints once the scheduler/services exist.2. Add a configuration option for `home`; filter TVs and tags displayed in the add-on to those matching that value.

3. **NEW: Implement TV config update endpoint:**

## 7. Backlog & Nice-to-Haves   - **Endpoint:** `POST /api/integration/tv-config`

- CI (lint + pytest) before public HACS release.   - **Headers:** `Content-Type: application/json`

- ‚ÄúRelease home claim‚Äù maintenance tool for metadata cleanup.   - **Body:**

- Automated token retirement for TVs inactive longer than N days.     ```json

- Dashboard card for shuffle history and quick actions.     {

- Public developer docs for services/entities.       "tvId": "c412b1e5a43346c6a947a894be2eda3a",

       "home": "madrone",

---       "config": {

Use this roadmap as the authoritative status tracker. Update the status badges (‚úÖ, üîÑ, üìù, üéØ, üöÄ) as milestones land.         "shuffleFrequencyMinutes": 30

       }
     }
     ```
   - **Response (success):** `200 {"success": true, "tv": {...}}`
   - **Response (home mismatch):** `400 {"error": "Home mismatch", "expected": "...", "received": "..."}`
   - **Response (not found):** `404 {"error": "TV not found"}`
   - On receipt: verify `home` matches the configured value, update shuffle frequency in metadata.json, reschedule shuffle service if active, return success/error.
4. **NEW: Add health check endpoint:** `GET /api/health` returning `{"status": "ok", "version": "x.y.z", "home": "madrone"}`
5. (Optional) Watch `metadata.json` for changes to catch manual edits or future automation.
6. Update add-on docs and UI copy to point users to Home Assistant for TV pairing.

**See**: [ARCHITECTURE_REFACTOR.md](ARCHITECTURE_REFACTOR.md) for complete implementation details including monitoring, error handling, and migration strategy.

## Phase 3 ‚Äì Control Surface Expansion
**Goal:** make the integration an effective controller for each TV.

Tasks:
- Introduce a DataUpdateCoordinator that polls/refreshes per-TV state (current image, last shuffle time, connectivity flags) and continues to respect the `home` filter.
- Expand entities:
  - `MediaPlayerEntity` (or custom entity) per TV for art mode on/off with state attributes.
  - Editable helper entities: `Number` for shuffle frequency, `Text` for IP/MAC, `Select` or `Text` for include/exclude tags. Editing writes back to metadata and calls the add-on endpoint.
  - Button entities triggering key actions (shuffle now, power on/off, refresh metadata, set brightness max).
- Wrap `frame_tv.py` helper calls via `hass.async_add_executor_job`; ensure executor use is centralized to simplify testing.
- Debounce metadata writes (e.g., lock + minimal delay) to prevent multiple quick edits from fighting each other.
- Add tests for service handlers, entity state updates, and metadata persistence when helper entities change.
- Documentation updates covering the new device controls.

## Phase 4 ‚Äì Full-System Automation
**Goal:** complete the art-shuffle loop with automation hooks and logging.

Tasks:
- Implement random image selection based on tags/exclude tags and integrate with `set_art_on_tv_delete_others`.
- Add structured logging (`/config/frame_art/log.json`) capturing image displays (TV, image, timestamps). Consider emitting HA events like `frame_art_shuffler.image_displayed` for native automations.
- Listen for add-on scheduling events (e.g., `frame_art_manager.shuffle_due`) and provide example HA automations linking events to services.
- Improve error handling: persistent notifications or Repairs entries when token pairing fails or TVs are unreachable; log to both HA and JSON log.
- Finalize documentation with end-to-end usage examples, automations, and troubleshooting.
- Expand test coverage (integration tests if possible) for shuffle flow, logging, and event handling.

## Add-on Work Checklist (for reference)
- [ ] Remove TV CRUD UI/routes; keep `GET /api/tvs` read-only.
- [ ] Introduce `home` setting and filter data accordingly.
- [ ] Implement `POST /api/tvs/sync` endpoint as specified.
- [ ] Optionally watch `metadata.json` for changes.
- [ ] Update documentation/UI language to reflect HA-managed TVs.

## Cross-Cutting Tasks and Backlog
- Maintain semantic versioning and changelog entries for each phase; cut new releases as capabilities land.
- Set up CI (lint, pytest) before publishing to HACS; ensure tests cover metadata helpers and config flow paths.
- Document migration steps for users moving from add-on managed TVs to the integration.
- Backlog ideas: home-claim cleanup service, orphan detection, more granular file watchers, richer UI dashboards, automated log rotation.

## Tracking Status
Use the chapters above as checkpoints. Before moving to the next phase, ensure all tasks in the current phase are complete, tests are green, documentation is updated, and (where relevant) a release is tagged. Add notes directly to this file as progress is made.
